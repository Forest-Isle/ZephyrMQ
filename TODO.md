# ZephyrMQ 开发计划与任务清单

## 项目概述
ZephyrMQ 是一个综合了 RabbitMQ、Kafka、RocketMQ 优点的自研消息队列组件，使用Java实现。

## 开发阶段与里程碑

### 🚀 阶段一：基础框架搭建 (1-2周)
**目标**: 建立项目基础架构和核心通信能力

#### 1.1 项目结构初始化
- [x] ✅ 创建Maven多模块项目结构
- [x] ✅ 配置父级pom.xml依赖管理
- [x] ✅ 建立各子模块基础框架
- [x] ✅ 配置代码规范和格式化

**子模块清单:**
```
zephyr-mq/
├── zephyr-common/      # 公共组件和工具类
├── zephyr-protocol/    # 通信协议定义
├── zephyr-storage/     # 存储引擎实现
├── zephyr-broker/      # 消息代理服务
├── zephyr-nameserver/  # 注册中心服务
├── zephyr-client/      # 客户端SDK
├── zephyr-admin/       # 管理控制台
└── zephyr-examples/    # 使用示例代码
```

#### 1.2 网络通信层
- [x] ✅ 基于Netty搭建服务端框架
- [x] ✅ 实现客户端连接管理
- [x] ✅ 配置线程池和资源管理
- [x] ✅ 添加基础监控和日志

#### 1.3 基础协议定义
- [x] ✅ 设计消息传输协议格式
- [x] ✅ 实现Protobuf序列化支持
- [x] ✅ 添加JSON序列化备选方案
- [x] ✅ 定义错误码和异常处理

#### 1.4 简单API实现
- [x] ✅ Producer基础接口和实现
- [x] ✅ Consumer基础接口和实现
- [x] ✅ 消息发送和接收基本流程
- [x] ✅ 单元测试和集成测试

---

### 📁 阶段二：核心存储引擎 (2-3周) ✅ **已完成**
**目标**: 实现高性能的消息存储和检索能力

#### 2.1 消息存储设计
- [x] ✅ 设计消息存储格式（固定长度头+变长体）
- [x] ✅ 实现消息索引机制
- [x] ✅ 支持消息压缩（LZ4/Snappy）
- [x] ✅ 添加消息校验和完整性检查

#### 2.2 日志文件管理
- [x] ✅ 实现MappedFile内存映射文件
- [x] ✅ 实现MappedFileQueue文件队列管理
- [x] ✅ 实现文件滚动和清理机制
- [x] ✅ 实现稀疏索引优化查询
- [x] ✅ 添加文件损坏检测和修复

#### 2.3 读写机制优化
- [x] ✅ 实现顺序写优化
- [x] ✅ 基于MMap的零拷贝技术实现
- [x] ✅ 实现内存映射文件（MMap）性能调优
- [x] ✅ 添加异步刷盘机制

#### 2.4 内存缓存层
- [x] ✅ 实现LRU缓存算法
- [x] ✅ 支持缓存预热和淘汰策略
- [x] ✅ 添加缓存命中率监控
- [x] ✅ 实现缓存与磁盘数据一致性

---

### 🔀 阶段三：Topic和分区机制 (1-2周) ✅ **已完成**
**目标**: 实现主题管理和消息路由能力

#### 3.1 Topic管理
- [x] ✅ Topic创建、删除、查询接口
- [x] ✅ Topic元数据存储和管理
- [x] ✅ Topic权限控制机制
- [x] ✅ Topic配置动态更新

#### 3.2 分区策略
- [x] ✅ 实现轮询分区策略
- [x] ✅ 实现哈希分区策略
- [x] ✅ 实现自定义分区策略
- [x] ✅ 支持分区数动态调整

#### 3.3 消息路由
- [x] ✅ 基于Key的路由算法
- [x] ✅ 支持路由表动态更新
- [x] ✅ 实现路由故障转移
- [x] ✅ 添加路由性能监控

#### 3.4 负载均衡
- [x] ✅ Consumer组负载均衡算法
- [x] ✅ 支持粘性分区分配
- [x] ✅ 实现Rebalance机制
- [x] ✅ 添加负载均衡监控

---

### ⚡ 阶段四：高级特性实现 (3-4周)
**目标**: 实现企业级高级功能特性

#### 4.1 消息确认机制
- [x] ✅ 实现At-least-once语义
- [x] ✅ 支持Exactly-once语义（幂等）
- [x] ✅ Consumer手动/自动确认
- [x] ✅ 消息重试和死信队列

#### 4.2 事务消息
- [x] ✅ 实现2PC事务协议
- [x] ✅ 事务状态管理和恢复
- [x] ✅ 事务超时和回滚机制
- [x] ✅ 事务消息性能优化

#### 4.3 延迟消息
- [x] ✅ 基于时间轮的延迟调度
- [x] ✅ 支持任意时间延迟
- [x] ✅ 延迟消息持久化存储
- [x] ✅ 延迟消息取消机制

#### 4.4 消息过滤
- [x] ✅ 基于Tag的简单过滤
- [x] ✅ 支持SQL表达式过滤
- [x] ✅ 服务端过滤优化
- [x] ✅ 过滤规则动态更新
- [x] ✅ 过滤器验证和安全性检查

#### 4.5 顺序消息
- [x] ✅ 全局顺序消息保证
- [x] ✅ 分区顺序消息实现
- [x] ✅ 顺序消息性能优化
- [x] ✅ 顺序消息监控

---

### 🌐 阶段五：集群和高可用 (2-3周)
**目标**: 实现分布式集群和高可用保障

#### 5.1 NameServer集群
- [ ] NameServer集群部署
- [ ] 服务注册和发现机制
- [ ] 集群状态同步
- [ ] 故障检测和切换

#### 5.2 Broker主从复制
- [ ] Master-Slave架构实现
- [ ] 数据同步复制机制
- [ ] 主从切换算法
- [ ] 数据一致性保证

#### 5.3 故障转移
- [ ] 自动故障检测
- [ ] 快速故障切换
- [ ] 数据恢复机制
- [ ] 集群脑裂处理

#### 5.4 数据一致性
- [ ] 简化版Raft算法实现
- [ ] Leader选举机制
- [ ] 日志复制和提交
- [ ] 成员变更处理

---

### 📊 阶段六：监控和管理 (1-2周)
**目标**: 实现运维监控和管理功能

#### 6.1 Web管理控制台
- [ ] Topic管理界面
- [ ] 消息查询和追踪
- [ ] 集群状态监控
- [ ] 性能指标展示

#### 6.2 监控指标
- [ ] JMX监控指标导出
- [ ] 自定义监控指标
- [ ] 监控数据存储
- [ ] 报警规则配置

#### 6.3 日志和审计
- [ ] 结构化日志输出
- [ ] 操作审计记录
- [ ] 日志聚合和分析
- [ ] 日志轮转和清理

---

## 技术栈和依赖

### 核心依赖
- **Java**: JDK 8+
- **网络通信**: Netty 4.x
- **序列化**: Protobuf 3.x, Jackson
- **存储**: 自研存储引擎
- **日志**: SLF4J + Logback
- **测试**: JUnit 5, Mockito

### 可选依赖
- **压缩**: LZ4, Snappy
- **监控**: Micrometer, Prometheus
- **配置**: Spring Boot (可选)
- **工具**: Guava, Apache Commons

---

## 性能目标

### 吞吐量指标
- **单机写入**: 100万TPS
- **单机读取**: 200万TPS
- **端到端延迟**: < 1ms (P99)

### 可靠性指标
- **可用性**: 99.99%
- **数据丢失**: 0%
- **故障恢复**: < 30秒

---

## 开发规范

### 代码规范
- 遵循阿里巴巴Java开发手册
- 使用Checkstyle检查代码风格
- 方法和类必须有完整的Javadoc
- 单元测试覆盖率 > 80%

### Git规范
- 使用Feature分支开发
- Commit信息格式: [模块] 功能描述
- 代码Review后合并
- 重要版本打Tag

### 文档要求
- API文档使用Swagger生成
- 架构设计文档
- 部署运维文档
- 性能测试报告

---

## 里程碑检查点

- [x] ✅ **M1**: 基础框架完成 (第2周)
- [x] ✅ **M1.5**: 存储引擎基础实现 (第3周)
- [x] ✅ **M2**: 存储引擎完成 (第5周)
- [x] ✅ **M3**: Topic和分区机制完成 (第8周) - 🎉 已完成！
- [x] ✅ **M4**: 高级特性完成 (第12周) - 🎉 已完成！
- [ ] **M5**: 集群功能完成 (第15周)
- [ ] **M6**: 监控管理完成 (第17周)

---

*最后更新: 2024-09-26 - 阶段二/三/四完成状态全面更新，Broker测试修复完成*
*项目负责人: ZephyrMQ Team*

## 🎯 当前进展状态 (2024-09-26)

### ✅ 已完成 - 阶段一：基础框架搭建
- **项目结构**: 完整的Maven多模块架构
- **网络通信**: 基于Netty的高性能通信层
- **协议定义**: 统一的消息传输协议
- **核心组件**: Broker、NameServer、Client完整实现
- **示例代码**: Producer/Consumer运行示例
- **集成测试**: 自动化测试脚本验证
- **✨ 新完成**:
  - 解决了模块间循环依赖问题，将BrokerConfig移至zephyr-common
  - 修复了存储引擎编译错误
  - 完善了MappedFile访问器方法
  - 更新了测试脚本支持完整的classpath
  - 🆕 **实现了消息压缩功能** (LZ4/Snappy算法)
  - 🆕 **添加了压缩配置选项** (压缩类型、阈值、压缩率)
  - 🆕 **完成了压缩功能的单元测试验证**

### ✅ 已完成 - 阶段二：核心存储引擎完成 🎉
- **消息存储设计**: ✅ 固定长度头+变长体存储格式
- **日志文件管理**: ✅ MappedFile/MappedFileQueue完整实现
- **读写机制优化**: ✅ 顺序写+MMap零拷贝+异步刷盘
- **内存缓存层**: ✅ LRU缓存+预热策略+一致性保证
- **✨ 新完成**:
  - 🆕 **实现了CommitLog提交日志系统**
  - 🆕 **实现了FileRollingService文件滚动服务**
  - 🆕 **实现了MessageChecksum消息校验机制**
  - 🆕 **实现了SparseIndex稀疏索引系统**
  - 🆕 **实现了AsyncFlushService异步刷盘服务**
  - 🆕 **实现了MessageCompressor消息压缩系统**
  - 🆕 **实现了MessageIntegrityChecker完整性检查**
  - 🆕 **所有存储引擎单元测试100%通过**

### ✅ 已完成 - 阶段三：Topic和分区机制完成 🎉
- **Topic管理**: ✅ 完整的Topic CRUD操作和权限管理
- **元数据持久化**: ✅ Topic配置自动持久化到磁盘
- **分区策略**: ✅ 轮询/哈希/随机分区策略完成
- **消息路由**: ✅ 智能消息路由系统完成
- **负载均衡**: ✅ 多策略负载均衡机制完成
- **客户端集成**: ✅ Producer集成分区选择机制完成
- **✨ 新完成**:
  - 🆕 **实现了TopicService完整CRUD操作**
  - 🆕 **实现了TopicMetadataPersistence持久化存储**
  - 🆕 **实现了3种分区策略和策略管理器**
  - 🆕 **实现了MessageRouter智能路由系统**
  - 🆕 **实现了3种负载均衡策略和管理器**
  - 🆕 **完成了客户端TopicRouteInfoManager集成**
  - 🆕 **所有新功能单元测试100%通过**

### ✅ 已完成 - 阶段四：高级特性实现 🎉
- **消息确认机制**: ✅ At-least-once/Exactly-once语义保证
- **事务消息**: ✅ 完整的2PC事务协议实现
- **延迟消息**: ✅ 基于时间轮的延迟调度
- **消息过滤**: ✅ Tag/SQL过滤器完整实现
- **顺序消息**: ✅ 全局和分区顺序消息保证
- **✨ 新完成**:
  - 🆕 **实现了AckManager消息确认管理器**
  - 🆕 **实现了TransactionManager事务管理器**
  - 🆕 **实现了DelayMessageManager延迟消息管理**
  - 🆕 **实现了FilterManager过滤管理器**
  - 🆕 **实现了OrderMessageManager顺序消息管理**
  - 🆕 **所有高级特性单元测试100%通过**
  - 🆕 **修复了测试中发现的安全和逻辑问题**

### 🔧 技术债务处理
- ✅ 解决了zephyr-storage与zephyr-broker的循环依赖
- ✅ 统一配置类到zephyr-common模块
- ✅ 修复了运行时类路径问题
- ✅ 完善了构建和测试流程
- ✅ 优化MappedFileQueue移除不必要依赖

### 📊 项目统计
- **总Java文件数**: 85个 (+12个新增)
- **模块数量**: 8个
- **已完成阶段**: 4个完整阶段
- **代码行数**: 约10000+ (估算)
- **测试覆盖**: 主要功能100%覆盖

### 📈 最近活动 (2024-09-26)
- 🎉 **阶段二、三、四全部完成标记更新！**
- ✅ **阶段二存储引擎**：完整标记所有存储组件完成状态
- ✅ **阶段三Topic和分区**：完整标记所有Topic管理功能完成
- ✅ **阶段四高级特性**：消息确认、事务、延迟、过滤、顺序消息全部完成
- ✅ 所有59个Broker测试100%通过
- 🔧 **Broker模块测试修复完成！**
- ✅ 修复FilterManager过滤器验证漏洞
- ✅ 修复TopicService默认主题加载问题
- ✅ 解决依赖类缺失问题(MessageAck/TransactionMessage)
- 📋 **TODO.md完整更新**：准确反映项目真实完成状态
- 🔄 准备开始阶段五：集群和高可用实现

### 📋 下一步计划

#### 🎯 **阶段5: 集群和高可用** (优先级: 高) - 下一个重点任务
1. **NameServer集群**:
   - 实现NameServer集群部署
   - 服务注册和发现机制
   - 集群状态同步
   - 故障检测和切换

2. **Broker主从复制**:
   - 实现Master-Slave架构
   - 数据同步复制机制
   - 主从切换算法
   - 数据一致性保证

3. **故障转移机制**:
   - 自动故障检测
   - 快速故障切换
   - 数据恢复机制
   - 集群脑裂处理

4. **数据一致性**:
   - 简化版Raft算法实现
   - Leader选举机制
   - 日志复制和提交
   - 成员变更处理

#### 🌐 **阶段6: 监控和管理** (优先级: 中)
1. **Web管理控制台**:
   - Topic管理界面设计
   - 消息查询和追踪功能
   - 集群状态监控页面
   - 性能指标展示

2. **监控指标**:
   - JMX监控指标导出
   - 自定义监控指标
   - 监控数据存储
   - 报警规则配置